# 完整用户旅程测试说明

## 概述

`p0_complete_user_journey.spec.ts` 是一个端到端测试，模拟真实用户从不同国家访问 Blacklyte 网站并完成所有关键操作。

## 测试流程

### 步骤 1: 打开首页并验证
- 导航到目标站点（根据 `TARGET` 环境变量）
- 关闭营销弹窗（"Get $30 off..." 等）
- 验证核心元素：
  - Logo/品牌标识
  - 导航菜单
  - 购物车入口
  - 首屏内容（避免白屏）

### 步骤 2: 搜索商品并进入详情页
- 打开搜索功能
- 搜索 "Athena"（热门商品）
- 验证搜索结果出现
- 点击第一个结果进入商品详情页
- 验证详情页加载

### 步骤 3: 添加商品到购物车
- 查找 "Add to Cart" 按钮
- 点击加购
- 验证加购成功（购物车数量变化或成功提示）

### 步骤 4: 进入购物车并前往结算
- 打开购物车页面
- 验证购物车中有商品
- 点击结算按钮
- 验证结算页加载（到支付前）

### 步骤 5: 处理登录和订阅弹窗
- 返回首页
- 关闭所有弹窗（订阅、登录等）
- 尝试触发登录弹窗（如果存在）
- 验证弹窗处理逻辑

### 步骤 6: 切换地区和币种
- 查找地区选择器
- 选择不同于当前地区的选项
- 验证 URL 或页面变化

### 步骤 7: 访问下载页
- 查找下载链接
- 访问下载页
- 验证下载页加载

## 证据收集

测试会自动收集以下证据（无论成功或失败）：

### 1. 网络摘要（network-summary.json）
- 失败请求列表
- 错误响应（4xx/5xx）
- 慢请求（>4s）
- 请求统计

### 2. 网络 HAR 文件（network.har）
- 完整的网络请求记录
- 可在 Chrome DevTools 中打开分析
- 包含所有请求的详细信息（headers、timings、response 等）

### 3. 控制台日志（console-logs.json）
- 所有控制台输出（info/warn/error）
- 便于查看页面运行时的日志

### 4. 控制台错误（console-errors.txt）
- 所有 JavaScript 错误
- 纯文本格式，便于快速查看

### 5. 失败的请求（failed-requests.json）
- 所有失败的 HTTP 请求
- 包含失败原因

### 6. Web Vitals（web-vitals.json）
- LCP (Largest Contentful Paint)
- CLS (Cumulative Layout Shift)
- INP (Interaction to Next Paint)

### 7. 页面截图（final-screenshot.png）
- 测试结束时的全页截图
- 便于查看最终页面状态

### 8. 页面 HTML（page-html.html）
- 测试结束时的完整 HTML
- 便于调试和查看 DOM 状态

### 自动收集（Playwright 配置）
- **Trace**: 失败时自动保留（可在 Playwright Inspector 中查看）
- **Video**: 失败时自动保留（完整操作录屏）
- **Screenshot**: 失败时自动截图

## 使用方法

### 本地运行

```bash
# 运行 US 站点的完整旅程
TARGET=US npx playwright test src/journeys/p0_complete_user_journey.spec.ts

# 运行 JP 站点的完整旅程
TARGET=JP npx playwright test src/journeys/p0_complete_user_journey.spec.ts

# 运行所有设备（Desktop + iPhone + Android）
TARGET=US npx playwright test src/journeys/p0_complete_user_journey.spec.ts

# 只运行桌面端
TARGET=US npx playwright test src/journeys/p0_complete_user_journey.spec.ts --project=desktop-chromium

# 调试模式（逐步执行）
TARGET=US npx playwright test src/journeys/p0_complete_user_journey.spec.ts --debug
```

### 查看测试报告

```bash
# 运行测试后查看 HTML 报告
npm run test:report

# 或直接运行
npx playwright show-report
```

### 查看证据文件

测试运行后，证据文件会附加到测试报告中：

1. **HTML 报告**：在浏览器中打开 `playwright-report/index.html`
2. **测试结果目录**：`test-results/` 目录下
3. **Trace 文件**：使用 `npx playwright show-trace <trace-file>` 查看

## Checkly 集成

### 配置建议

```yaml
# .checkly.yml
browserChecks:
  - name: P0_COMPLETE_USER_JOURNEY - US
    activated: true
    locations:
      - us-east-1
    schedule: "*/10 * * * *"
    script: |
      npx playwright test src/journeys/p0_complete_user_journey.spec.ts --project=desktop-chromium
    environmentVariables:
      TARGET: US
    alertSettings:
      escalationType: RUN_BASED
      runBasedEscalation:
        failedRunThreshold: 2
    tags:
      - P0
      - US
      - complete-journey
```

### 错峰调度

为每个 Region 创建独立的检查，错峰执行：

- US: `*/10 * * * *` (每 10 分钟，从 0 分开始)
- CA: `2-59/10 * * * *` (每 10 分钟，从 2 分开始)
- EU: `4-59/10 * * * *` (每 10 分钟，从 4 分开始)
- UK: `6-59/10 * * * *` (每 10 分钟，从 6 分开始)
- AU: `8-59/10 * * * *` (每 10 分钟，从 8 分开始)
- JP: `1-59/10 * * * *` (每 10 分钟，从 1 分开始)

## 故障排查

### 测试失败时

1. **查看 Trace 文件**：
   ```bash
   npx playwright show-trace test-results/.../trace.zip
   ```

2. **查看视频**：
   - 在 HTML 报告中直接播放
   - 或查看 `test-results/` 目录下的 `.webm` 文件

3. **查看 HAR 文件**：
   - 下载 `network.har` 文件
   - 在 Chrome DevTools > Network > Import HAR file 中打开
   - 或使用在线工具：https://toolbox.googleapps.com/apps/har_analyzer/

4. **查看控制台错误**：
   - 打开 `console-errors.txt`
   - 查看所有 JavaScript 错误

5. **查看网络摘要**：
   - 打开 `network-summary.json`
   - 查找失败的请求和错误响应

### 常见问题

1. **选择器找不到元素**：
   - 查看截图，确认页面状态
   - 检查选择器是否需要更新
   - 查看 HTML 文件，确认 DOM 结构

2. **超时错误**：
   - 检查网络连接
   - 增加超时时间（在测试中设置 `test.setTimeout()`）
   - 查看网络摘要，确认是否有慢请求

3. **弹窗未关闭**：
   - 查看截图，确认弹窗类型
   - 更新 `closePopup` 函数，添加新的选择器

## 维护建议

1. **定期更新选择器**：网站改版时，及时更新选择器
2. **监控 Web Vitals**：关注性能趋势，及时发现问题
3. **分析失败请求**：定期检查失败请求，优化资源加载
4. **优化测试速度**：根据实际情况调整超时时间

## 注意事项

1. **测试超时**：完整旅程测试设置为 2 分钟，确保有足够时间完成所有步骤
2. **证据收集**：所有证据都会收集，无论测试成功或失败
3. **Web Vitals**：当前阶段只记录，不强制失败（避免误报）
4. **控制台错误**：建议监控，但可根据实际情况决定是否作为失败条件

