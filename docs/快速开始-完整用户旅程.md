# 完整用户旅程测试 - 快速开始

## 测试概述

`p0_complete_user_journey.spec.ts` 是一个端到端测试，模拟真实用户从不同国家访问 Blacklyte 网站并完成所有关键操作。

## 测试流程（7 个步骤）

1. ✅ **打开首页** → 关闭弹窗 → 验证核心元素
2. ✅ **搜索商品**（Athena）→ 进入详情页
3. ✅ **加购** → 验证购物车状态
4. ✅ **进入结算页**（到支付前）
5. ✅ **处理登录/订阅弹窗**
6. ✅ **切换地区/币种**
7. ✅ **访问下载页**

## 快速运行

```bash
# 运行 US 站点的完整旅程（所有设备）
TARGET=US npx playwright test src/journeys/p0_complete_user_journey.spec.ts

# 只运行桌面端（推荐，速度更快）
TARGET=US npx playwright test src/journeys/p0_complete_user_journey.spec.ts --project=desktop-chromium

# 运行其他 Region
TARGET=JP npx playwright test src/journeys/p0_complete_user_journey.spec.ts --project=desktop-chromium
TARGET=EU npx playwright test src/journeys/p0_complete_user_journey.spec.ts --project=desktop-chromium
```

## 自动收集的证据

测试失败时，会自动收集以下证据：

### 1. 截图和录屏（自动）
- **Screenshot**: 失败时自动截图
- **Video**: 失败时自动录屏（完整操作过程）
- **Trace**: 失败时保留 trace（可在 Playwright Inspector 中查看）

### 2. 网络数据
- **network-summary.json**: 网络请求摘要（失败请求、错误响应、慢请求）
- **network.har**: 完整的网络请求记录（可在 Chrome DevTools 中打开）

### 3. 控制台日志
- **console-logs.json**: 所有控制台输出
- **console-errors.txt**: 所有 JavaScript 错误

### 4. 性能数据
- **web-vitals.json**: LCP、CLS、INP 等性能指标

### 5. 页面状态
- **final-screenshot.png**: 测试结束时的全页截图
- **page-html.html**: 最终 DOM 状态

## 查看证据

### 方法 1: HTML 报告（推荐）

```bash
# 运行测试后查看报告
npm run test:report
```

在浏览器中打开报告，所有证据都会附加在测试结果中。

### 方法 2: Trace 文件（最详细）

```bash
# 查看 trace 文件（最详细的调试信息）
npx playwright show-trace test-results/.../trace.zip
```

在 Playwright Inspector 中你可以：
- 查看每一步操作
- 查看页面快照
- 查看网络请求
- 查看控制台日志
- 时间线回放

### 方法 3: HAR 文件分析

1. 下载 `network.har` 文件（从测试报告中）
2. 在 Chrome DevTools 中打开：
   - 打开 Chrome DevTools
   - 切换到 Network 标签
   - 右键点击请求列表
   - 选择 "Import HAR file"
3. 或使用在线工具：https://toolbox.googleapps.com/apps/har_analyzer/

## 故障排查

### 如果测试失败

1. **查看截图**：了解失败时的页面状态
2. **查看视频**：回放整个操作过程
3. **查看 Trace**：最详细的调试信息
4. **查看 HAR**：分析网络请求问题
5. **查看控制台错误**：定位 JavaScript 错误

### 常见问题

1. **元素找不到**：
   - 查看截图，确认页面状态
   - 检查选择器是否需要更新
   - 查看 HTML 文件，确认 DOM 结构

2. **点击被拦截**：
   - 测试已使用 `force: true` 和 `scrollIntoViewIfNeeded` 处理
   - 如果仍然失败，可能需要等待更长时间

3. **超时错误**：
   - 测试超时设置为 3 分钟（180秒）
   - 如果仍然超时，可能需要优化网络或增加超时时间

## 测试特点

✅ **多地区支持**：通过 `TARGET` 环境变量切换不同 Region  
✅ **随机化**：随机语言、随机延迟，模拟真实用户  
✅ **完整证据**：失败时自动收集所有证据  
✅ **健壮性**：使用多种选择器策略，适配不同页面状态  
✅ **详细日志**：每个步骤都有清晰的日志输出  

## 下一步

1. 运行测试验证功能
2. 根据实际网站结构调整选择器
3. 集成到 Checkly 进行持续监控
4. 配置告警策略（P0：连续失败 2 次告警）

