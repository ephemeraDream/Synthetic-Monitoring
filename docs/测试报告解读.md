# 测试报告解读指南

## 测试失败原因分析

### 1. 移动端（iPhone/Android）失败

**错误信息：**
```
Error: expect(locator).toBeVisible() failed
Locator: locator('nav').first()
Expected: visible
Received: hidden
```

**原因：**
- 移动端网站通常使用**汉堡菜单**（☰），导航菜单默认是**隐藏**的
- `nav` 元素虽然存在于 DOM 中，但 CSS 设置为 `display: none` 或 `visibility: hidden`
- 这是**正常的设计模式**，不是 bug

**修复方案：**
- ✅ 已更新测试：移动端检查菜单按钮是否存在，而不是强制要求 nav 可见
- ✅ 移动端会尝试打开菜单后再验证导航链接

### 2. 桌面端（Chromium）失败

**错误信息：**
```
Error: expect(locator).toBeVisible() failed
Locator: locator('[aria-label*="cart" i], [data-testid*="cart" i], .cart').first()
Expected: visible
Received: hidden
```

**原因：**
- 选择器匹配到了**弹窗的关闭按钮**，而不是真正的购物车图标
- 关闭按钮的 `aria-label` 是 `"Translation missing: ja.cart.ajax_cart.close"`，包含了 "cart" 关键词
- 这个按钮是隐藏的（用于关闭购物车弹窗）

**修复方案：**
- ✅ 已更新测试：优先查找购物车链接（`a[href*="cart"]`）
- ✅ 如果找不到链接，会检查按钮的 `aria-label`，排除包含 "close" 的按钮
- ✅ 使用更精确的选择器，避免误匹配

## 测试报告结构

### 测试结果类型

1. **✅ 通过（Pass）**：所有断言都成功
2. **❌ 失败（Fail）**：至少一个断言失败
3. **⏭️ 跳过（Skip）**：测试被跳过（例如活动已过期）

### 报告附件

每次测试失败都会生成以下附件：

1. **Screenshot（截图）**
   - 路径：`test-results/[test-name]/test-failed-1.png`
   - 用途：查看失败时的页面状态

2. **Video（视频）**
   - 路径：`test-results/[test-name]/video.webm`
   - 用途：回放整个测试过程

3. **Trace（追踪文件）**
   - 路径：`test-results/[test-name]/trace.zip`
   - 用途：使用 Playwright Inspector 详细调试
   - 查看命令：`npx playwright show-trace test-results/[test-name]/trace.zip`

4. **Network Summary（网络摘要）**
   - 格式：JSON
   - 内容：失败请求、错误响应、慢请求

### 查看报告

```bash
# 查看 HTML 报告
npm run test:report

# 或直接运行测试后查看
npx playwright test --reporter=html
```

## 常见问题

### Q: 为什么移动端和桌面端的测试结果不同？

**A:** 因为：
- 移动端和桌面端的 UI 设计不同
- 移动端使用汉堡菜单，导航默认隐藏
- 桌面端导航直接可见
- 这是**正常现象**，测试已经针对不同设备做了适配

### Q: 如何查看详细的失败信息？

**A:** 使用 Trace 文件：
```bash
npx playwright show-trace test-results/[test-name]/trace.zip
```

在 Playwright Inspector 中你可以：
- 查看每一步操作
- 查看页面快照
- 查看网络请求
- 查看控制台日志

### Q: 测试失败是否意味着网站有问题？

**A:** 不一定：
- 可能是测试选择器需要更新（网站改版）
- 可能是临时网络问题
- 可能是弹窗/加载状态导致的时序问题
- 需要结合截图和 trace 文件判断

### Q: 如何判断是测试问题还是网站问题？

**A:** 检查清单：
1. ✅ 查看截图：页面是否正常加载？
2. ✅ 查看视频：操作流程是否正确？
3. ✅ 查看网络摘要：是否有 4xx/5xx 错误？
4. ✅ 查看控制台：是否有 JS 错误？
5. ✅ 手动访问网站：是否能复现问题？

## 测试优化建议

### 1. 选择器优先级（已遵循）

1. `getByRole` - 最可靠
2. `text` - 用户可见文本
3. `url` - URL 路径
4. `aria` - ARIA 属性
5. `css` - CSS 选择器（最后选择）

### 2. 避免依赖的内容

- ❌ 价格（可能变化）
- ❌ 库存数量（可能变化）
- ❌ 促销文案（可能过期）
- ❌ 具体商品名称（可能下架）

### 3. 必须验证的内容

- ✅ 页面核心元素存在
- ✅ 导航功能可用
- ✅ 关键操作可执行
- ✅ 无白屏/崩溃
- ✅ 无严重 JS 错误

## 下一步

1. **运行修复后的测试**：
   ```bash
   TARGET=US npx playwright test src/journeys/p0_home.spec.ts
   ```

2. **如果仍然失败**：
   - 查看截图和视频
   - 使用 trace 文件调试
   - 根据实际页面结构调整选择器

3. **持续优化**：
   - 根据实际运行情况调整选择器
   - 增加重试机制
   - 优化等待时间

